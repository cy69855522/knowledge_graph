# 3.1 KV Cache (Key-Value Cache) ğŸ”‘

## ğŸ¯ æ ¸å¿ƒç›®æ ‡
ä¸ºä»€ä¹ˆå¤§æ¨¡å‹æ¨ç†è¿™ä¹ˆåƒæ˜¾å­˜ï¼Ÿå› ä¸ºæˆ‘ä»¬è¦å­˜ **KV Cache**ã€‚

## ğŸ’¡ æ¦‚å¿µè§£æ

### 1. ä»€ä¹ˆæ˜¯ KV Cache? ğŸ¤”
åœ¨ Transformer çš„è‡ªå›å½’ (Auto-regressive) ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œä¸ºäº†é¿å…é‡å¤è®¡ç®—å·²ç»ç”Ÿæˆè¿‡çš„ token çš„ Key å’Œ Value çŸ©é˜µï¼Œæˆ‘ä»¬å°†å®ƒä»¬ç¼“å­˜ä¸‹æ¥ã€‚
Attention æœºåˆ¶æœ¬èº«æ˜¯ O(N^2) çš„ï¼Œä½†å› ä¸ºæ˜¯ Causal (åªèƒ½çœ‹è¿‡å»)ï¼Œæˆ‘ä»¬å¯ä»¥å¤ç”¨ä¹‹å‰çš„è®¡ç®—ç»“æœã€‚

### 2. ä¸ºä»€ä¹ˆéœ€è¦å®ƒ? (The Why)
å¦‚æœä¸ç¼“å­˜ï¼Œæ¯ç”Ÿæˆä¸€ä¸ªæ–°è¯ï¼Œéƒ½è¦æŠŠä¹‹å‰æ‰€æœ‰çš„è¯é‡æ–°ç®—ä¸€é Attentionã€‚
*   ç”Ÿæˆç¬¬ 1000 ä¸ªè¯ï¼šè®¡ç®—é‡ 1000ã€‚
*   ç”Ÿæˆç¬¬ 1001 ä¸ªè¯ï¼šè®¡ç®—é‡ 1001ã€‚
*   æ€»å¤æ‚åº¦: O(N^2)ã€‚æ…¢å¾—åƒä¹Œé¾Ÿ ğŸ¢ã€‚

å¦‚æœç¼“å­˜äº† (KV Cache)ï¼š
*   ç”Ÿæˆç¬¬ 1000 ä¸ªè¯ï¼šåªç®—è¿™ 1 ä¸ªæ–°è¯çš„å’Œå‰é¢ 999 ä¸ª cached K/V çš„ Attentionã€‚
*   æ€»å¤æ‚åº¦: O(N)ã€‚é£å¿« ğŸ‡ã€‚

#### ğŸ“¸ CV å·¥ç¨‹å¸ˆç±»æ¯”
*   **Video Object Tracking (è§†é¢‘ç›®æ ‡è·Ÿè¸ª):**
    *   **Naive æ–¹æ³•:** æ¯æ¥ä¸€å¸§æ–°å›¾åƒï¼Œä½ éƒ½æŠŠ *ä»ç¬¬ä¸€å¸§åˆ°å½“å‰å¸§* çš„æ‰€æœ‰å›¾åƒé‡æ–°è¾“å…¥ CNN æå–ç‰¹å¾ã€‚ -> æ˜¾å¡å†’çƒŸ ğŸ’¥ã€‚
    *   **KV Cache æ–¹æ³•:** ä½ åªè®¡ç®— *æ–°çš„ä¸€å¸§* çš„ç‰¹å¾ï¼Œå¹¶å¤ç”¨ä¹‹å‰ä¿å­˜ä¸‹æ¥çš„ç‰¹å¾å›¾ (Feature Maps) æ›´æ–°çŠ¶æ€ (Hidden State)ã€‚
    *   **åŒºåˆ«:** CV çš„ç‰¹å¾å›¾å¤§å°é€šå¸¸å›ºå®š (å¦‚ `H x W`)ï¼Œä½†åœ¨ LLM ä¸­ï¼Œéšç€ç”Ÿæˆ token å¢åŠ ï¼ŒKV Cache çš„**åºåˆ—é•¿åº¦ (Sequence Length) æ˜¯ä¸æ–­å¢é•¿çš„** ğŸ“ˆã€‚

## âš”ï¸ è¯¾åå®æˆ˜ (Action Items)
1.  **ç®—ä¸€ç®—:** Llama-2-7B (float16) å­˜ä¸€ä¸ª token çš„ KV Cache éœ€è¦å¤šå°‘æ˜¾å­˜ï¼Ÿ
    *   å…¬å¼: `2 (K+V) * n_layers * n_heads * head_dim * sizeof(float16)`
    *   Llama-2-7B: 32 layers, 32 heads, 128 dim.
    *   `2 * 32 * 32 * 128 * 2 bytes = 524,288 bytes` â‰ˆ **0.5 MB / token**ã€‚
    *   å¦‚æœä½ æœ‰ 2048 context lengthï¼Œä¸€ä¸ªç”¨æˆ·å°±è¦åƒæ‰ 1GB æ˜¾å­˜ï¼User * Batchï¼Œæ˜¾å­˜ç¬é—´çˆ†ç‚¸ ğŸ’¥ã€‚
