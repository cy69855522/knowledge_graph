# 第十四章：稀疏矩阵乘法 (SpMV)

## 核心概念

### 14.1 稀疏矩阵
大多数元素为零的矩阵。压缩存储避免存储和计算零元素。

### 14.2 存储格式

#### COO (Coordinate List)
```cpp
// 存储每个非零元素的 (行, 列, 值)
float value[];   // 非零值
int rowIdx[];    // 行索引
int colIdx[];    // 列索引
```

**特点**：灵活，可任意顺序存储，适合构建矩阵

#### CSR (Compressed Sparse Row)
```cpp
float value[];    // 非零值（按行分组）
int colIdx[];     // 列索引
int rowPtrs[];    // 每行起始位置 (长度 = 行数 + 1)
```

**特点**：空间高效，便于访问一行的所有元素

#### ELL (ELLPACK)
```cpp
// 填充使每行元素数相同，按列主序存储
float value[numRows][maxNnzPerRow];  // 列主序
int colIdx[numRows][maxNnzPerRow];
```

**特点**：内存合并访问，但有填充开销

#### JDS (Jagged Diagonal Storage)
- 按行长度排序
- 减少填充
- 减少控制分歧

### 14.3 SpMV 内核

#### COO 版本
```cpp
__global__ void spmv_coo(float *value, int *rowIdx, int *colIdx, 
                         float *x, float *y, int nnz) {
    int i = blockIdx.x * blockDim.x + threadIdx.x;
    if (i < nnz) {
        atomicAdd(&y[rowIdx[i]], value[i] * x[colIdx[i]]);
    }
}
```
- ✅ 负载均衡
- ✅ 内存合并
- ❌ 需要原子操作

#### CSR 版本
```cpp
__global__ void spmv_csr(float *value, int *colIdx, int *rowPtrs,
                         float *x, float *y, int numRows) {
    int row = blockIdx.x * blockDim.x + threadIdx.x;
    if (row < numRows) {
        float sum = 0;
        for (int i = rowPtrs[row]; i < rowPtrs[row + 1]; i++) {
            sum += value[i] * x[colIdx[i]];
        }
        y[row] = sum;
    }
}
```
- ✅ 无原子操作
- ❌ 内存不合并
- ❌ 负载不均衡

#### ELL 版本
```cpp
__global__ void spmv_ell(float *value, int *colIdx, int *nnzPerRow,
                         float *x, float *y, int numRows) {
    int row = blockIdx.x * blockDim.x + threadIdx.x;
    if (row < numRows) {
        float sum = 0;
        for (int i = 0; i < nnzPerRow[row]; i++) {
            int idx = i * numRows + row;  // 列主序
            sum += value[idx] * x[colIdx[idx]];
        }
        y[row] = sum;
    }
}
```
- ✅ 内存合并
- ❌ 填充开销
- ❌ 负载不均衡

### 14.4 混合格式 (ELL-COO)

将异常长的行用 COO 存储，其余用 ELL：
- 减少 ELL 填充
- 保持大部分行的合并访问

## 关键要点

| 格式 | 空间效率 | 内存合并 | 负载均衡 | 灵活性 |
|-----|---------|---------|---------|--------|
| COO | 中 | ✅ | ✅ | ✅ |
| CSR | 高 | ❌ | ❌ | 中 |
| ELL | 低 | ✅ | ❌ | 中 |
| JDS | 中 | ✅ | 较好 | 低 |

### 设计考虑
1. **空间效率**：存储开销
2. **灵活性**：添加/删除元素的难度
3. **可访问性**：访问行/列/元素的便利性
4. **内存效率**：合并访问程度
5. **负载均衡**：线程间工作量差异

### 性能特点
- SpMV 是**内存带宽受限**的（OP/B ≈ 0.25）
- 实际 FLOPS 远低于峰值
- 格式选择取决于矩阵结构
